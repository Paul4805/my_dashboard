<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Editor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="/static/css/dashboard_editor.css">
</head>
<body>

<div class="editor-container">
  <input type="hidden" id="dashboardId" value="{{ dashboard_id or '' }}">
  <div class="tools-panel">
    <div class="top-toolbar">
      <h3>Tools</h3>
      <div class="toolbar-actions">
        <a href="/dashboard/bidashboard" class="exit-editor-btn" title="Exit Editor">Exit</a>
        <button class="save-btn" title="Save Dashboard">Save</button>
        <button id="resetCanvasBtn" class="reset-btn" title="Reset Canvas">Reset</button>
      </div>

      <div class="section-divider"></div>

      <div class="control-group">
        <label for="zoomRange">Zoom:</label>
        <div class="zoom-controls">
          <input type="range" id="zoomRange" min="50" max="200" value="60" />
          <span id="zoomValue">60%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="canvas-size">Canvas Size:</label>
        <select id="canvas-size">
          <option value="a4">A4 (595x842 px)</option>
          <option value="a3">A3 (842x1191 px)</option>
          <option value="custom">Custom</option>
        </select>
        <div id="custom-size-inputs" class="custom-size-inputs" style="display: none;">
          <input type="number" id="custom-width" placeholder="Width (px)" aria-label="Custom width" />
          <input type="number" id="custom-height" placeholder="Height (px)" aria-label="Custom height" />
          <button id="applyCustomSizeBtn" class="apply-btn">Apply</button>
        </div>
      </div>

      <div class="section-divider"></div>

      <div id="chartCustomControls" class="chart-custom-controls"></div>
    </div>

    <div class="bottom-toolbar" id="widgetListBar">
      <h4>Widgets</h4>
    </div>
  </div>

  <div class="canvas-area" id="canvasArea">
    <div class="scroll-buffer">
      <div id="zoomWrapper">
        <div class="canvas" id="dashboardCanvas"></div>
      </div>
    </div>
  </div>

  <div class="sidebar-right">
    <h3>Design with AI</h3>
    <div class="control-group">
      <label for="dashboardPrompt">Describe your dashboard:</label>
      <textarea id="dashboardPrompt" placeholder="e.g., Show monthly revenue comparison for 2024..." aria-label="Dashboard prompt"></textarea>
    </div>

    <div class="control-group">
      <label for="chart-type">Select Chart Type (Optional):</label>
      <select id="chart-type">
        <option value="">-- Select Chart Type --</option>
        <option value="line">Line Graph</option>
        <option value="bar">Bar Graph</option>
        <option value="pie">Pie Chart</option>
      </select>
    </div>

    <div class="control-group">
      <label for="db-select">Select Data Source:</label>
      <select id="db-select">
        {% for db in db_list %}
        <option value="{{ db }}">{{ db }}</option>
        {% endfor %}
      </select>
    </div>

    <button id="generateDashboardBtn" class="generate-btn">Generate Dashboard</button>
  </div>
</div>

<div id="saveDashboardModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeSaveModal" title="Close">&times;</span>
    <h3>Save Your Dashboard</h3>
    <input type="text" id="dashboardNameInput" placeholder="Enter dashboard name..." class="dashboard-name-input" />
    <div class="modal-actions">
      <button id="confirmSaveBtn" class="confirm-btn">ðŸ’¾ Save</button>
      <button id="cancelSaveBtn" class="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

  {% block scripts %}
    <script type="module" src="/static/js/dashboard/state.js"></script>
    <script type="module" src="/static/js/dashboard/core.js"></script>
    <script type="module" src="/static/js/dashboard/drag_resize.js"></script>
    <script type="module" src="/static/js/dashboard/helper.js"></script>
    <script type="module" src="/static/js/dashboard/render_chart.js"></script>
    <script type="module" src="/static/js/dashboard/restore.js"></script>
    <script type="module" src="/static/js/dashboard/save.js"></script>
    <script type="module" src="/static/js/dashboard/widget_manager.js"></script>
    <script type="module" src="/static/js/dashboard/zoom.js"></script>
    <script type="module" src="/static/js/dashboard/reset.js"></script> 
  {% endblock %}

  {% if dashboard_data %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Clear any existing session data
      sessionStorage.removeItem('widgets');
      sessionStorage.removeItem('canvasSize');

      // Restore from server data
      const dashboardData = JSON.parse('{{ dashboard_data | tojson | safe | escapejs }}');
      restoreDashboardFromData(dashboardData);
    });
  </script>
  {% endif %}

</body>
</html>
