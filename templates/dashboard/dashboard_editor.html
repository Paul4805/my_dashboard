<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Editor</title>
  <link rel="icon" href="{{ url_for('static', path='/favicon.ico') }}" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="/static/css/dashboard_editor.css">
</head>
<body>

<div class="editor-container">
  <input type="hidden" id="dashboardId" value="{{ dashboard_id or '' }}">
  <!-- Tool Panel -->
  <div class="tools-panel">
    <div class="top-toolbar">
      <h3>Tools</h3>
      <a href="/dashboard/bidashboard" class="editor-button exit-button">Exit Editor</a>
      <button class="editor-button save-button">Save Dashboard</button>
      <div class="export-dropdown">
        <button class="editor-button export-button" onclick="toggleExportDropdown()">Export As â¬‡</button>
        <div id="exportOptions" class="dropdown-content">
          <button onclick="exportAsPDF()">ðŸ“„ PDF</button>
        </div>
      </div>
      <div class="zoom-bar">
        <label for="zoomRange">Zoom:</label><br>
        <input type="range" id="zoomRange" min="50" max="200" value="100" />
        <span id="zoomValue">100%</span>
      </div>
      <div class="dropdown-container">
        <label for="canvas-size">Canvas Size:</label>
        <select id="canvas-size" class="styled-dropdown">
          <option value="a4">A4 (595x842 px)</option>
          <option value="a3">A3 (842x1191 px)</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <!-- Inside tools-panel custom size apply -->
      <div id="custom-size-inputs" style="display: none; margin-top: 8px;">
        <input type="number" id="custom-width" placeholder="Width (px)" />
        <input type="number" id="custom-height" placeholder="Height (px)" />
        <button id="applyCustomSizeBtn">Apply</button>
      </div>

      <div id="chartCustomControls" style="margin-top: 20px;"></div>
    </div>

    <div class="bottom-toolbar" id="widgetListBar"></div>
  </div>

  <!-- Canvas Area -->
  <div class="canvas-area" id="canvasArea">
    <div class="scroll-buffer">
      <div id="zoomWrapper">
        <div class="canvas" id="dashboardCanvas">
        </div>
      </div>
    </div>
  </div>

  <!-- AI Input Panel -->
  <div class="sidebar-right">
    <h3>Describe your dashboard</h3>
    <label for="db-select" style="font-size: 13px; margin-top: 5px;">Data Source:</label>
    <select id="db-select" style="width: 100%; padding: 4px; font-size: 13px; margin-bottom: 12px;">
      {% for db in db_list %}
      <option value="{{ db }}">{{ db }}</option>
      {% endfor %}
    </select>

    <textarea id="dashboardPrompt" placeholder="e.g., Show monthly revenue comparison for 2024..."></textarea>
    <div style="margin-top: 10px;">
      <label for="chart-type">Select Chart Type:</label>
      <br><br>
      <select id="chart-type">
        <option value="">-- Select Chart Type (Optional) --</option>
        <option value="line">Line Graph</option>
        <option value="bar">Bar Graph</option>
        <option value="pie">Pie Chart</option>
      </select>
    </div>
    <!-- Inside sidebar-right generate dashboard button -->
    <button id="generateDashboardBtn">Generate Dashboard</button>

  </div>
</div>

<!-- Save Modal -->
<div id="saveDashboardModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeSaveModal">&times;</span>
    <h3>Save Your Dashboard</h3>
    <input type="text" id="dashboardNameInput" placeholder="Enter dashboard name..." style="width: 100%; margin-top: 15px; padding: 8px;" />
    <div style="margin-top: 20px; text-align: right;">
      <button id="confirmSaveBtn" class="db-option">ðŸ’¾ Save</button>
      <button id="cancelSaveBtn" class="db-option" style="background-color: gray;">Cancel</button>
    </div>
  </div>
</div>

{% block scripts %}
  <!-- Load state.js first since other modules depend on it -->
  <script type="module" src="/static/js/dashboard/state.js"></script>
  <script type="module" src="/static/js/dashboard/core.js"></script>
  <script type="module" src="/static/js/dashboard/drag_resize.js"></script>
  <script type="module" src="/static/js/dashboard/helper.js"></script>
  <script type="module" src="/static/js/dashboard/render_chart.js"></script>
  <script type="module" src="/static/js/dashboard/restore.js"></script>
  <script type="module" src="/static/js/dashboard/save.js"></script>
  <script type="module" src="/static/js/dashboard/widget_manager.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script type="module">
    import { dashboardState } from '/static/js/dashboard/state.js';
    
    document.addEventListener('DOMContentLoaded', () => {
      {% if dashboard_data %}
      // Initialize state
      dashboardState.isInitialServerLoad = true;
      
      // Clear any existing session data
      sessionStorage.removeItem('widgets');
      sessionStorage.removeItem('canvasSize');
      
      // Restore from server data
      restoreDashboardFromData({{ dashboard_data | tojson | safe }});
      
      // Update state after restoration
      dashboardState.isInitialServerLoad = false;
      {% endif %}
    });
  </script>
  <script>
  function toggleExportDropdown() {
    document.querySelector('.export-dropdown').classList.toggle('show');
  }

  async function exportAsPDF() {
    const zoomWrapper = document.getElementById("zoomWrapper");
    const dashboardCanvas = document.getElementById("dashboardCanvas");

    // Save and reset zoom
    const originalTransform = zoomWrapper.style.transform;
    zoomWrapper.style.transform = "scale(1)";

    // Wait for zoom reset to take effect
    await new Promise(r => setTimeout(r, 100));

    const canvasBounds = dashboardCanvas.getBoundingClientRect();

    const canvasImage = await html2canvas(dashboardCanvas, {
      scale: 2,
      width: canvasBounds.width,
      height: canvasBounds.height,
      useCORS: true
    });

    const imgData = canvasImage.toDataURL("image/png");

    const pdf = new jspdf.jsPDF({
      orientation: canvasBounds.width > canvasBounds.height ? 'landscape' : 'portrait',
      unit: "px",
      format: [canvasImage.width, canvasImage.height],
    });

    pdf.addImage(imgData, "PNG", 0, 0, canvasImage.width, canvasImage.height);
    pdf.save("dashboard.pdf");

    // Restore original zoom
    zoomWrapper.style.transform = originalTransform;
  }

  </script>
  {% endblock %}

</body>
</html>


